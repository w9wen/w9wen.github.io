I"÷2<p>åœ¨Xamarin.Formsçš„Coreå°ˆæ¡ˆè¦å¯¦ç¾è·¨å¹³å°å­˜å–ç…§ç›¸æ©Ÿã€æ”å½±æ©Ÿæˆ–ç›¸ç°¿ï¼Œè¦å®‰è£è¨­å®šMediaPluginï¼Œè«‹åƒè€ƒ<a href="https://github.com/jamesmontemagno/MediaPlugin">MediaPlugin by James Montemagno</a>ã€‚</p>

<h3 id="ç‚ºå„å¹³å°å»ºç«‹æ¬Šé™">ç‚ºå„å¹³å°å»ºç«‹æ¬Šé™</h3>

<h4 id="xamarinandroid">Xamarin.Android</h4>
<ol>
  <li>æ‰“é–‹å°ˆæ¡ˆå±¬æ€§ç·¨è¼¯Android Manifestï¼Œå°‡WRITE_EXTERNAL_STORAGE ä»¥åŠ READ_EXTERNAL_STORAGEæ‰“å‹¾ï¼Œè€Œåœ¨Marshmallowä¸Š(ä¸æ˜¯æ¯å€‹APIéƒ½éœ€è¦ï¼Œä½†Marshmallowä½¿ç”¨è€…çœ¾ï¼Œå°±å®‰è£å¥½äº†)åŸ·è¡Œæ™‚è¦æç¤ºä½¿ç”¨è€…ä½¿ç”¨Nativeæ™‚ï¼Œä¾¿éœ€è¦å®‰è£PermissionPluginï¼Œè«‹åœ¨æ–¹æ¡ˆä¸ŠæŒ‰å³éµï¼Œä½¿ç”¨Nugetç®¡ç†å“¡å®‰è£åœ¨ä¸‰å€‹å°ˆæ¡ˆä¸­ï¼Œä¸¦åœ¨Xamarin.Androidçš„MainActivityä¸­override OnRequestPermissionsResultï¼Œç¨‹å¼ç¢¼å¦‚ä¸‹
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnRequestPermissionsResult</span><span class="p">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="p">,</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">permissions</span><span class="p">,</span> <span class="p">[</span><span class="n">GeneratedEnum</span><span class="p">]</span> <span class="n">Permission</span><span class="p">[]</span> <span class="n">grantResults</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">base</span><span class="p">.</span><span class="nf">OnRequestPermissionsResult</span><span class="p">(</span><span class="n">requestCode</span><span class="p">,</span> <span class="n">permissions</span><span class="p">,</span> <span class="n">grantResults</span><span class="p">);</span>
      <span class="n">PermissionsImplementation</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="nf">OnRequestPermissionsResult</span><span class="p">(</span><span class="n">requestCode</span><span class="p">,</span> <span class="n">permissions</span><span class="p">,</span> <span class="n">grantResults</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>å®‰è£è¨­å®šCurrentActivity Plugin
  è«‹åƒè€ƒ<a href="/xamarin/xamarin.forms/plugin/install-currentactivity-plugin-access-xamarin-android-activity/">[Xamarin.Forms] å®‰è£CurrentActivity Pluginè—‰ä»¥å­˜å–Xamarin.Android Activity</a></li>
  <li>è²æ˜è£ç½®å¿…é ˆæ€§ï¼Œåœ¨AssemblyInfo.csåŠ å…¥ä»¥ä¸‹ç¨‹å¼ç¢¼
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">UsesFeature</span><span class="p">(</span><span class="s">"android.hardware.camera"</span><span class="p">,</span> <span class="n">Required</span> <span class="p">=</span> <span class="k">false</span><span class="p">)]</span>
 <span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="nf">UsesFeature</span><span class="p">(</span><span class="s">"android.hardware.camera.autofocus"</span><span class="p">,</span> <span class="n">Required</span> <span class="p">=</span> <span class="k">false</span><span class="p">)]</span>
</code></pre></div>    </div>
  </li>
  <li>ç‚ºäº†æŒ‡å®šå­˜å–æª”æ¡ˆè³‡æ–™å¤¾ï¼Œçµ±ä¸€åœ¨AndroidManifest.xmlçš„<code class="language-plaintext highlighter-rouge">&lt;application&gt;</code>é€²è¡Œä»¥ä¸‹é…ç½®
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="nt">&lt;provider</span> <span class="na">android:name=</span><span class="s">"android.support.v4.content.FileProvider"</span>
             <span class="na">android:authorities=</span><span class="s">"${applicationId}.fileprovider"</span>
             <span class="na">android:exported=</span><span class="s">"false"</span>
             <span class="na">android:grantUriPermissions=</span><span class="s">"true"</span><span class="nt">&gt;</span>

       <span class="nt">&lt;meta-data</span> <span class="na">android:name=</span><span class="s">"android.support.FILE_PROVIDER_PATHS"</span>
                      <span class="na">android:resource=</span><span class="s">"@xml/file_paths"</span><span class="nt">&gt;&lt;/meta-data&gt;</span>
     <span class="nt">&lt;/provider&gt;</span>
</code></pre></div>    </div>
    <p>é‚„æ²’å®Œï¼Œæˆ‘ç´¯äº†~~~ğŸ˜«ï¼Œé€™æ˜¯è·¨å¹³å°å¿…ç¶“éç¨‹å—?ä¸éï¼Œå…ˆè‹¦å¾Œç”˜
4.å»ºç«‹ä¸€å€‹Appå­˜å–æª”æ¡ˆå°ˆå±¬çš„è·¯å¾‘ï¼Œåœ¨Resroucesä¸‹å»ºç«‹ä¸€å€‹åç‚ºâ€xmlâ€çš„è³‡æ–™å¤¾ï¼Œåº•ä¸‹å¢åŠ ä¸€å€‹åç‚ºâ€file_pathsâ€çš„xmlæª”æ¡ˆï¼Œå…§å®¹å¦‚ä¸‹</p>
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
 <span class="nt">&lt;paths</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;external-files-path</span> <span class="na">name=</span><span class="s">"my_images"</span> <span class="na">path=</span><span class="s">"Pictures"</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;external-files-path</span> <span class="na">name=</span><span class="s">"my_movies"</span> <span class="na">path=</span><span class="s">"Movies"</span> <span class="nt">/&gt;</span>
 <span class="nt">&lt;/paths&gt;</span>
</code></pre></div>    </div>
    <p>çµæŸâ€¦.ğŸ”š~~~Android</p>
  </li>
</ol>

<h4 id="xamarinios">Xamarin.iOS</h4>
<p>é€™å€’ç°¡å–®äº†ï¼Œå°±åªéœ€è¦åœ¨info.plistå¢åŠ ç›¸æ©Ÿã€ç›¸ç°¿çš„æ¬Šé™å®£å‘Šå³å¯ï¼Œè«‹åƒè€ƒ<a href="https://blog.xamarin.com/new-ios-10-privacy-permission-settings/">New iOS 10 Privacy Permission Settings</a>ã€‚</p>

<h3 id="å®‰è£media-plugin">å®‰è£Media Plugin</h3>
<p>åœ¨æ–¹æ¡ˆä¸­å¹«æ‰€æœ‰çš„Xamarinå°ˆæ¡ˆå®‰è£Xam.Plugin.Media
  <img src="/images/2018/04/install-mediaplugin-01.png" alt="install-mediaplugin.01" /></p>

<h3 id="ä½¿ç”¨è·¨å¹³å°pluginå­˜å–native">ä½¿ç”¨è·¨å¹³å°Pluginå­˜å–Native</h3>

<ol>
  <li>Mdeia.plugin åˆå§‹åŒ–
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">await</span> <span class="n">CrossMedia</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">();</span>
</code></pre></div>    </div>
  </li>
  <li>æª¢æŸ¥ç›¸æ©Ÿèˆ‡ç›¸ç°¿æ¨¡çµ„
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">if</span> <span class="p">(!</span><span class="n">CrossMedia</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">IsCameraAvailable</span> <span class="p">||</span> <span class="p">!</span><span class="n">CrossMedia</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">IsTakePhotoSupported</span><span class="p">)</span>
  <span class="p">{</span>
   <span class="k">await</span> <span class="nf">DisplayAlert</span><span class="p">(</span><span class="s">"å¤šåª’é«”æ¨¡çµ„"</span><span class="p">,</span> <span class="s">"ç›¸æ©Ÿæˆ–ç›¸ç°¿ä¸æ”¯æ´"</span><span class="p">,</span> <span class="s">"ç¢ºå®š"</span><span class="p">);</span>
   <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>  
</code></pre></div>    </div>
  </li>
  <li>æª¢æŸ¥æç¤ºä½¿ç”¨è€…é–‹æ”¾å­˜å–æ¬Šé™
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">if</span> <span class="p">(</span><span class="n">cameraStatus</span> <span class="p">!=</span> <span class="n">PermissionStatus</span><span class="p">.</span><span class="n">Granted</span> <span class="p">||</span> <span class="n">storageStatus</span> <span class="p">!=</span> <span class="n">PermissionStatus</span><span class="p">.</span><span class="n">Granted</span><span class="p">)</span>
  <span class="p">{</span>
   <span class="kt">var</span> <span class="n">results</span> <span class="p">=</span> <span class="k">await</span> <span class="n">CrossPermissions</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="nf">RequestPermissionsAsync</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="n">Permission</span><span class="p">.</span><span class="n">Camera</span><span class="p">,</span> <span class="n">Permission</span><span class="p">.</span><span class="n">Storage</span> <span class="p">});</span>
   <span class="n">cameraStatus</span> <span class="p">=</span> <span class="n">results</span><span class="p">[</span><span class="n">Permission</span><span class="p">.</span><span class="n">Camera</span><span class="p">];</span>
   <span class="n">storageStatus</span> <span class="p">=</span> <span class="n">results</span><span class="p">[</span><span class="n">Permission</span><span class="p">.</span><span class="n">Storage</span><span class="p">];</span>
  <span class="p">}</span>  
</code></pre></div>    </div>
  </li>
  <li>åœ¨å­˜å–æ¬Šé™çš„æƒ…æ³ä¸‹ï¼Œå–å¾—ç›¸æ©Ÿæˆ–ç›¸ç°¿ï¼Œè©³ç´°è¨­å®šå¯ä»¥åƒè€ƒMedia Pluginçš„æ–‡ä»¶
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">if</span> <span class="p">(</span><span class="n">cameraStatus</span> <span class="p">==</span> <span class="n">PermissionStatus</span><span class="p">.</span><span class="n">Granted</span> <span class="p">&amp;&amp;</span> <span class="n">storageStatus</span> <span class="p">==</span> <span class="n">PermissionStatus</span><span class="p">.</span><span class="n">Granted</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="kt">var</span> <span class="n">file</span> <span class="p">=</span> <span class="k">await</span> <span class="n">CrossMedia</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="nf">TakePhotoAsync</span><span class="p">(</span><span class="k">new</span> <span class="n">StoreCameraMediaOptions</span>
  <span class="p">{</span>
      <span class="n">DefaultCamera</span> <span class="p">=</span> <span class="n">CameraDevice</span><span class="p">.</span><span class="n">Front</span><span class="p">,</span> <span class="c1">// Androidç„¡æ³•åŸ·è¡Œ</span>
      <span class="c1">//AllowCropping = true,</span>
      <span class="c1">//SaveToAlbum = true</span>
      <span class="c1">//SaveMetaData = true,</span>
      <span class="c1">//PhotoSize = PhotoSize.Medium,</span>
      <span class="c1">//CompressionQuality = 92</span>
      <span class="c1">//Directory = "Sample",</span>
      <span class="c1">//Name = "test.jpg"</span>
  <span class="p">});</span>

  <span class="c1">//var file = await CrossMedia.Current.PickPhotoAsync(new PickMediaOptions { });</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>

  <span class="c1">//await DisplayAlert("File Location", file.Path, "OK");</span>

  <span class="n">ImageShow</span><span class="p">.</span><span class="n">Source</span> <span class="p">=</span> <span class="n">ImageSource</span><span class="p">.</span><span class="nf">FromStream</span><span class="p">(()</span> <span class="p">=&gt;</span>
  <span class="p">{</span>
      <span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">GetStream</span><span class="p">();</span>
      <span class="k">return</span> <span class="n">stream</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
  <span class="k">await</span> <span class="nf">DisplayAlert</span><span class="p">(</span><span class="s">"ä½¿ç”¨è€…æ¬Šé™"</span><span class="p">,</span> <span class="s">"ç„¡æ³•å­˜å–ç›¸æ©Ÿæˆ–ç›¸ç°¿"</span><span class="p">,</span> <span class="s">"ç¢ºå®š"</span><span class="p">);</span>
  <span class="c1">//On iOS you may want to send your user to the settings screen.</span>
  <span class="c1">//CrossPermissions.Current.OpenAppSettings();</span>
  <span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="ios-çœ‹-android-phone">iOS çœ‹ Android Phone</h3>
<p><img src="/images/2018/04/install-mediaplugin-04.PNG" alt="  install-mediaplugin-04" />
  <img src="/images/2018/04/install-mediaplugin-05.PNG" alt="  install-mediaplugin-05" /></p>

<h3 id="android-çœ‹-iphone">Android çœ‹ iPhone</h3>
<p><img src="/images/2018/04/install-mediaplugin-02.png" alt="" />
  <img src="/images/2018/04/install-mediaplugin-03.png" alt="install-mediaplugin-02" /></p>
:ET